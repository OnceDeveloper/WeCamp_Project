<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wecamp.mapper.TestMapper"><!-- route of mapping to java -->
	<select id="selectCampIdx" resultType="int" parameterType="String">
		select CAMP_IDX from OWNER where EMAIL = #{email}
	</select>
	
	<select id="selectCountBookingList" resultType="long" parameterType="hashmap">
		<choose>
			<when test="@com.wecamp.utils.MyBatisCheck@notEmpty(search)">
				<choose>
					<when test='category.equals("name")'>
						<![CDATA[
						select nvl(count(*), 0) from BOOKING join B_STATE on BOOKING.S_NO = B_STATE.S_NO
						join CAMP on BOOKING.CAMP_IDX = CAMP.CAMP_IDX
						join SORT on BOOKING.SORT_IDX = SORT.SORT_IDX
						where BOOKING.CAMP_IDX = #{camp_idx} and CHECK_IN <= #{today} and CHECK_OUT >= #{today}
						and BOOKING.NAME like '%'||#{keyword}||'%'
						]]>
					</when>
					<when test='category.equals("tel")'>
						<![CDATA[
						select nvl(count(*), 0) from BOOKING join B_STATE on BOOKING.S_NO = B_STATE.S_NO
						join CAMP on BOOKING.CAMP_IDX = CAMP.CAMP_IDX
						join SORT on BOOKING.SORT_IDX = SORT.SORT_IDX
						where BOOKING.CAMP_IDX = #{camp_idx} and CHECK_IN <= #{today} and CHECK_OUT >= #{today}
						and BOOKING.TEL like '%'||#{keyword}||'%'
						]]>
					</when>
				</choose>
			</when>
			<otherwise>
				<![CDATA[
				select nvl(count(*), 0) from BOOKING join B_STATE on BOOKING.S_NO = B_STATE.S_NO
				join CAMP on BOOKING.CAMP_IDX = CAMP.CAMP_IDX
				join SORT on BOOKING.SORT_IDX = SORT.SORT_IDX
				where BOOKING.CAMP_IDX = #{camp_idx} and CHECK_IN <= #{today} and CHECK_OUT >= #{today}
				]]>
			</otherwise>
		</choose>
	</select>
	
	<select id="selectCountUsingStateAsT" resultType="int" parameterType="hashmap">
		<![CDATA[
		select nvl(count(*), 0) from BOOKING
		where BOOKING.CAMP_IDX = #{camp_idx} and CHECK_IN <= #{today} and CHECK_OUT >= #{today}
		and USING_STATE = 'T'
		]]>
	</select>
	
	<select id="selectCountUsingStateAsF" resultType="int" parameterType="hashmap">
		<![CDATA[
		select nvl(count(*), 0) from BOOKING
		where BOOKING.CAMP_IDX = #{camp_idx} and CHECK_IN <= #{today} and CHECK_OUT >= #{today}
		and USING_STATE = 'F'
		]]>
	</select>
	
	<select id="selectCountUsingStateAsU" resultType="int" parameterType="hashmap">
		<![CDATA[
		select nvl(count(*), 0) from BOOKING
		where BOOKING.CAMP_IDX = #{camp_idx} and CHECK_IN <= #{today} and CHECK_OUT >= #{today}
		and USING_STATE = 'U'
		]]>
	</select>
	
	<select id="selectBookingList" resultType="com.wecamp.model.BookingAndCamp" parameterType="hashMap">
		<choose>
			<when test="@com.wecamp.utils.MyBatisCheck@notEmpty(search)">
				<choose>
					<when test='category.equals("name")'>
						<![CDATA[
						select * from (
						select ROWNUM rnum, aa.* from (
						select * from BOOKING join B_STATE on BOOKING.S_NO = B_STATE.S_NO
						join CAMP on BOOKING.CAMP_IDX = CAMP.CAMP_IDX
						join SORT on BOOKING.SORT_IDX = SORT.SORT_IDX
						where BOOKING.CAMP_IDX = #{camp_idx} and CHECK_IN <= #{today} and CHECK_OUT >= #{today}
						and BOOKING.NAME like '%'||#{keyword}||'%'
						)aa) 
						where rnum>#{page.startRow} and rnum<=#{page.endRow}
						]]>
					</when>
					<when test='category.equals("tel")'>
						<![CDATA[
						select * from (
						select ROWNUM rnum, aa.* from (
						select * from BOOKING join B_STATE on BOOKING.S_NO = B_STATE.S_NO
						join CAMP on BOOKING.CAMP_IDX = CAMP.CAMP_IDX
						join SORT on BOOKING.SORT_IDX = SORT.SORT_IDX
						where BOOKING.CAMP_IDX = #{camp_idx} and CHECK_IN <= #{today} and CHECK_OUT >= #{today}
						and BOOKING.TEL like '%'||#{keyword}||'%'
						)aa) 
						where rnum>#{page.startRow} and rnum<=#{page.endRow}
						]]>
					</when>
				</choose>
			</when>
			<otherwise>
				<![CDATA[
				select * from (
				select ROWNUM rnum, aa.* from (
				select * from BOOKING join B_STATE on BOOKING.S_NO = B_STATE.S_NO
				join CAMP on BOOKING.CAMP_IDX = CAMP.CAMP_IDX
				join SORT on BOOKING.SORT_IDX = SORT.SORT_IDX
				where BOOKING.CAMP_IDX = #{camp_idx} and CHECK_IN <= #{today} and CHECK_OUT >= #{today}
				)aa) 
				where rnum>#{page.startRow} and rnum<=#{page.endRow}
				]]>
			</otherwise>
		</choose>
	</select>
	
	<update id="updateUsingState" parameterType="hashmap">
		<choose>
			<when test='action.equals("start")'>
				update BOOKING set USING_STATE = 'U' where IMP_UID = #{imp_uid}
			</when>
			<when test='action.equals("end")'>
				update BOOKING set USING_STATE = 'T' where IMP_UID = #{imp_uid}
			</when>
		</choose>
	</update>
</mapper>